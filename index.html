<!DOCTYPE html>
<html>
<head>
    <title>Live newsdesk</title>
    <link rel="stylesheet" href="css/fonts.css"></style>
    <link rel="stylesheet" href="css/style.css"></style>
    <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="libs/lodash.js"></script>
</head>
<body>
    
    <div class="header">Live newsdesk</div>
    <img src="css/newsdesk.gif" class="pulser" >
    <div class="items"></div>

    <!--[if lte IE 9]><style type="text/css">
    /* Old IE doesn't support CSS transform or transitions */
    .items div { position: relative }
    </style><![endif]-->

    <script>
        var toneWhitelist = [
                "timelines",
                "comment",
                //"help",
                //"thirdpartyventures",
                //"sponsoredfeatures",
                //"extract",
                "matchreports",
                "albumreview",
                "features",
                "obituaries",
                "minutebyminute",
                "editorials",
                "interview",
                //"recipes",
                //"readeroffers",
                "performances",
                //"extracompetitions",
                //"resource",
                //"letters",
                "reviews",
                "profiles",
                "blog",
                "livereview",
                //"extraoffers",
                "analysis",
                "q-and-as",
                //"advertisement-features",
                //"event-descriptions",
                //"childrens-user-reviews"
                "news"
            ],

            listLength = 12,
            rowHeightPx = 30,

            refreshPeriod = 5000,

            capi =  'http://content.guardianapis.com/search' + 
                    '?api-key=gnm-hackday' + 
                    '&use-date=last-modified' + 
                    '&order-by=newest' +
                    '&page-size=' + listLength + 
                    '&tag=' + toneWhitelist.map(function(t) { return 'tone/' + t; }).join('|'),

            template = _.template(
                '<div>' + 
                    '<span class="label-new">new</span>' +
                    '<span class="label-updated">updated</span>' +
                    '<a target="_top" href="http://www.theguardian.com/<%= id %>" title="<%- webTitle %>"><%- webTitle %></a>' +
                '</div>'),

            $items = $(".items"),

            //useShaphots = true,
            useShaphots = window.location.hash.indexOf("snapshots") > -1,
            snaphotCount = useShaphots ? loadSnapshoCount() : 0,
            snaphotBase = 'http://stephanfowler.com/gu-live-hack/snapshotter/data/',
            snaphotMin = 100,
            snaphotMax = 150,
            snaphotCount = 0,

            storageKeyState = 'gu.live.state',
            storageKeySnapshotCount = 'gu.live.snapshotCount',

            domMap,
            titlesMap;

        // Workaround for Webkit bug: force scroll height to be recomputed after the transition ends, not only when it starts
        /*
        $items.on("webkitTransitionEnd", function () {
            $(this).hide().offset();
            $(this).show();
        });
        */

        function getDomList() {
            var list = _.map($('div', $items));
            return list.length ? list : null;
        }

        function cleanUp() {
            _.forEach(domMap, function(el, id) {
                if (el.deleted) {
                    $(el).remove();
                    delete domMap[id];
                    delete titlesMap[id];
                } else {
                    $(el).removeClass();
                    delete el.reposition;
                }
            })
        }

        function setPosition(el, i) {
            el.position = i;
            if (_.isUndefined(el.reposition) || el.reposition) {
                $(el).css('top', i * rowHeightPx);
            }
        }

        function setPositions(list) {
            _.forEach(list, setPosition);
        }

        function markForDeletion(el) {
            $(el).addClass('deleted');
            el.deleted = true;
        }

        function simplify(article) {
            return _.pick(article, ['id', 'webTitle']);
        }

        function load() {
            var model = window.sessionStorage.getItem(storageKeyState);

            model = model && JSON.parse(model);
            model = _.isArray(model) && model;
            return model;
        }

        function save(model) {
            window.sessionStorage.setItem(storageKeyState, JSON.stringify(model));
        }

        function loadSnapshoCount() {
            var count = window.sessionStorage.getItem(storageKeySnapshotCount) || 0;
            return parseInt(count, 10);
        }

        function saveSnapshoCount(count) {
            window.sessionStorage.setItem(storageKeySnapshotCount, count + '');
        }

        function fetchModel() {
            var defer = new $.Deferred(),
                url = capi;

            if (useShaphots) {
                url = snaphotBase + (snaphotMin + snaphotCount);
                snaphotCount += 1;
                snaphotCount = snaphotMin + snaphotCount > snaphotMax ? 0 : snaphotCount;
                saveSnapshoCount(snaphotCount);
            }

            $.ajax({
                url: url,
                dataType: 'jsonp',
                jsonpCallback: 'jsonpFn'
            }).done(function(data) {
                if (data && data.response && _.isArray(data.response.results)) {
                    defer.resolve(data.response.results.map(simplify));
                } else {
                    defer.reject();
                }
            }).fail(function() {
                defer.reject();
            });

            return defer;
        }

        function areIdentical(a, b) {
            return _.isEqual(a, b);
        }

        function differCompletely(a, b) {
            return _.intersection(_.pluck(a, 'id'), _.pluck(b, 'id')).length === 0;
        }

        function fullRender(content) {
            var domList;

            if (_.isArray(content)) {
                $items.html(content.map(template).join(''));
                domList = getDomList();
                domMap = _.zipObject(_.pluck(content, 'id'), domList);
                setPositions(domList);

                titlesMap = _.reduce(content, function (map, article) {
                    map[article.id] = article.webTitle;
                    return map;
                }, {});
            }
        }

        function mutateRender(oldModel, newModel) {
            var domList = [];

            cleanUp();

            _.chain(newModel)
                .forEach(function(article, i) {
                    var id = article.id,
                        title = article.webTitle,
                        el = domMap[id];

                    if (!el) {
                        el = $(template(article)).addClass('new').appendTo($items);
                        domMap[id] = el;
                        titlesMap[id] = title;
                    } else if (i < el.position) {
                        $(el).addClass('updated');
                    }

                    if (titlesMap[id] !== title) {
                        $('a', el).html(title);
                        $(el).addClass('updated');
                    }

                    el.reposition = i !== el.position;
                    domList.push(el);
                })
                .value();

            _.chain(domMap)
                .filter(function(el) { return _.isUndefined(el.reposition); })
                .forEach(markForDeletion)
                .value();

            setTimeout(function() {
                setPositions(domList);
            });
        }

        function update(oldModel) {
            fetchModel()
            .done(function(newModel) {
                if (differCompletely(oldModel, newModel)) {
                    fullRender(newModel);
                    save(newModel);
                } else if (!areIdentical(oldModel, newModel)) {
                    mutateRender(oldModel, newModel);
                    save(newModel);
                }

                setTimeout(function() {
                    update(newModel);
                }, refreshPeriod);
            })
        }

        function init() {
            fetchModel()
            .done(function(newModel) {
                var oldModel = load();

                if (!oldModel
                    || areIdentical(oldModel, newModel)
                    || differCompletely(oldModel, newModel)) {
                    fullRender(newModel);

                } else {
                    fullRender(oldModel);
                    setTimeout(function() {
                        mutateRender(oldModel, newModel);
                    }, 1000);
                }

                save(newModel);

                setTimeout(function() {
                    update(newModel);
                }, refreshPeriod);
            })
        }

        init();

    </script>
</body>
</html>
