<!DOCTYPE html>
<html>
<head>
    <title></title>
    <style>
        body { font-family: Arial; overflow: hidden; }
        .items { 
            font-size: 14px;
            line-height: 27px;
            height: 330px;
        }
        .items div { 
            box-sizing: border;
            width: 100%;
            padding-left: 5px;
            border-top: 1px solid #ddd;
            background: #fff;
            overflow: hidden;
            white-space: nowrap;
            position: absolute;
            top: -27px;
            left: 0;
            transition: all 1s ease-in-out;
            color: #000;
        }
        .items div.new {
            background: #C5E1A5;
        }
        .items div.rising {
            background: #FFD180;
        }
        .items div a {
            color: #000;
            text-decoration: none;
        }
        .items div.falling a {
            color: #999;
        }

    </style>
    <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="libs/lodash.js"></script>
</head>
<body>
    <ul class="items"></ul>

    <!--[if lte IE 9]><style type="text/css">
    /* Old IE doesn't support CSS transform or transitions */
    .items div { position: relative }
    </style><![endif]-->

    <script>
        $(function() {
            var template = _.template('<div id="<%= id %>"><a href="<%= webUrl %>"><%= webTitle %></a></div>'),
                $items = $(".items");

            function render(content) {
                if (content) {
                    $items.html(content.map(template).join(''));
                    setPositions(getDomList());
                }
            }

            function getDomList() {
                return _.map($('div', $items));
            }

            function getDomMap() {
                return _.reduce(getDomList(), function(domMap, el, i) {
                    el.position = i;
                    domMap[el.id] = el;
                    return domMap;
                }, {});
            }

            function prepareDom() {
                getDomList().forEach(function(el, i) {
                    clearClasses(el);
                    setZindex(el, i)
                })
            }

            function setPosition(el, i) {
                $(el).css('top', i * 27 );
            }

            function setPositions(list) {
                list.forEach(setPosition);
            }

            function setZindex(el, i) {
                $(el).css('z-index', i + 1);
            }

            function clearClasses(el) {
                $(el).removeClass();
            }

            // Workaround for Webkit bug: force scroll height to be recomputed after the transition ends, not only when it starts
            $items.on("webkitTransitionEnd", function () {
                $(this).hide().offset();
                $(this).show();
            });

            function simplify(article) {
                return _.pick(article, ['id', 'webTitle', 'webUrl', 'tags']);
            }

            function loadList() {
                var state = window.localStorage.getItem('gu.live.state');

                state = state && JSON.parse(state);
                state = _.isArray(state) && state;
                return state;
            }

            function saveList(list) {
                window.localStorage.setItem('gu.live.state', JSON.stringify(list));
            }

            function fetchList() {
                var defer = new $.Deferred();;

                $.ajax({
                   url: 'http://content.guardianapis.com/search?api-key=test&show-tags=all&page-size=14',
                   dataType:'jsonp'
                }).done(function(data) {
                    var list = data.response.results;

                    list = _.shuffle(list);
                    defer.resolve(list.slice(0, 12).map(simplify));
                });

                return defer.promise();
            }

            function init() {
                render(loadList());

                fetchList().done(function(list) {
                    var domMap = getDomMap(),
                        version = new Date().getTime();

                    if (_.isEmpty(domMap)) {
                        render(list);

                    } else {
                        prepareDom();

                        _.chain(list)
                            .forEach(function(article, index) {
                                var el = domMap[article.id];

                                if (!el) {
                                    el = $(template(article)).addClass('new').appendTo($items)                                    
                                } else if (index < el.position) {
                                    $(el).addClass('rising');
                                } else if (index > el.position) {
                                    $(el).addClass('falling');
                                }
                                el.version = version;
                                setTimeout(function() {
                                    setPosition(el, index)
                                }, 0);
                            })
                            .value();

                        _.chain(domMap)
                            .forEach(function(el, id) {
                                if (el.version !== version) {
                                    $(el).remove();
                                    delete domMap[id];
                                }
                            })
                            .value();
                    }

                    saveList(list);
                });
            }

            init();
        });
    </script>
</body>
</html>