<!DOCTYPE html>
<html>
<head>
    <title></title>
    <style>
        body { font-family: Arial; overflow: hidden; }
        .items { 
            font-size: 14px;
            line-height: 27px;
            list-style-type: none;
            padding: 0;
            position: relative;
            height: 390px;
            overflow: hidden;
        }
        .items .item { 
            box-sizing: border;
            width: 100%;
            padding-left: 5px;
            border-top: 1px solid #ddd;
            background: #fff;
            margin-bottom: 3px;
            overflow: hidden;
            white-space: nowrap;
            position: absolute;
            top: 0;
            left: 0;
            transition: all 0.5s;
            color: #000;
        }
        .items .item.new {
            color: #fff;
            background: #1c6326;
        }
        .items .item.rising {
            color: #fff;
            background: #e6711b;
        }
    </style>
    <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="libs/lodash.js"></script>
</head>
<body>
    <ul class="items"></ul>
    <button class="reload">Reload</button> 

    <!--[if lte IE 9]><style type="text/css">
    /* Old IE doesn't support CSS transform or transitions */
    .items .item { position: relative }
    </style><![endif]-->

    <script>
        $(function() {
            var template = _.template('<div class="item" id="<%= id %>""><%= webTitle %></div>');

            function generateInitial(content) {
                $('.items').html(content.map(template).join(''))
                return getList();
            }

            function getList() {
                return _.map(document.querySelectorAll('.items .item'));
            }

            function getMap() {
                return _.reduce(document.querySelectorAll('.items .item'), function(map, el) {
                    map[el.id] = el;
                    return map;
                }, {});
            }

            function tidyUp(list) {
                setTimeout(function () {
                    list.forEach(setZindex);
                }, 500);
                setTimeout(function() {
                    list.forEach(function(el) {
                        $(el).attr('class', 'item');
                    })
                }, 2000);
            }

            function setPosition(el, i) {
                $(el).css('top', i * 27 );
            }

            function setPositions(list) {
                list.forEach(setPosition);
            }

            function setZindex(el, i) {
                $(el).css('z-index', i + 10);
            }

            // Workaround for Webkit bug: force scroll height to be recomputed after the transition ends, not only when it starts
            $(".items").on("webkitTransitionEnd", function () {
                $(this).hide().offset();
                $(this).show();
            });

            function add(article, position) {
                $(template(article))
                    .addClass('new')
                    .insertBefore($(".items").children()[position || 0]);
            }

            function move(article, from, to) {
                var list = getList();

                $(list[from]).addClass(from > to ? 'rising' : 'falling').detach().insertBefore(list[to]);
            }

            function getContent() {
                var defer = new $.Deferred();;

                $.ajax({
                   type:'GET',
                   url: 'http://content.guardianapis.com/search?api-key=test&show-tags=all&page-size=12',
                   dataType:'jsonp'
                }).done(function(results) {
                    results = results.response.results;
                    results = _.shuffle(results);
                    defer.resolve(results.slice(0, 10));
                });
                return defer.promise();
            }

            var idsOld;

            function init() {
                getContent().done(function(results) {
                    var els,
                        map;

                    if (!idsOld) {
                        setPositions(generateInitial(results));

                    } else {
                        idsNew = _.pluck(results, 'id');
                        map = getMap();

                        _.chain(map)
                            .forEach(function(el, id) {
                                if (idsNew.indexOf(id) === -1) {
                                    delete map[id];
                                    $(el).remove();
                                }
                            })
                            .value();

                        els = _.chain(results)
                            .forEachRight(function(article, index) {
                                var el = map[article.id];

                                if (!el) {
                                    el = $(template(article)).addClass('new').prependTo($(".items"))                                    
                                } else if (index < idsOld.indexOf(article.id)) {
                                    $(el).addClass('rising');
                                }

                                setPosition(el, index);
                            })
                            .value();
                    }

                    tidyUp(getList());
                    idsOld = _.pluck(results, 'id');
                });
            }

            $(".reload").click(function () {
                init();
            });

            init();

        });
    </script>
</body>
</html>